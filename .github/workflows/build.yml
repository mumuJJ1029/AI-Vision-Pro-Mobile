name: Build Android APK (Official Docker)
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build with Kivy Docker
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取代码
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. 彻底重写 buildozer.spec (防止任何修改失败)
      # 我们直接生成一份最完美的配置文件，不给 Buildozer 犯错的机会
      - name: Generate Perfect Spec File
        run: |
          cat <<EOF > buildozer.spec
          [app]
          title = AI Vision Pro
          package.name = aivisionpro
          package.domain = com.niujuzhang
          source.dir = .
          source.include_exts = py,png,jpg,kv,atlas,ttf,json
          version = 0.1
          
          # 【黄金组合】Kivy 2.3.0 + KivyMD 1.2.0
          requirements = python3,kivy==2.3.0,kivymd==1.2.0,requests,urllib3,chardet,idna,pillow,openssl
          
          # 图标与启动图
          icon.filename = icon.png
          presplash.filename = icon.png
          
          # 屏幕方向
          orientation = portrait
          
          # 权限全开
          android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE
          
          # Android API 设置 (兼容性最佳)
          android.api = 34
          android.minapi = 24
          android.ndk = 25b
          android.accept_sdk_license = True
          
          # 架构支持
          android.archs = arm64-v8a
          
          # 其他设置
          p4a.branch = master
          android.allow_backup = True
          
          [buildozer]
          log_level = 2
          warn_on_root = 1
          EOF
          
          echo "✅ 完美配置文件 buildozer.spec 已生成！"

      # 3. 修正权限 (Docker 可能会有权限问题，先赋予所有权)
      - name: Fix Permissions
        run: |
          sudo chmod -R 777 .

      # 4. 启动 Kivy 官方 Docker 进行构建
      # 这是最关键的一步！使用官方镜像，环境绝对纯净稳定
      - name: Build APK with Docker
        uses: docker://kivymd/buildozer:latest
        with:
          args: buildozer android debug

      # 5. 上传战利品
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AI-Vision-Pro-Final-APK
          path: bin/*.apk
