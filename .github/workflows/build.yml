name: Build Android APK
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Buildozer & Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libffi-dev libssl-dev python3-pip python3-setuptools python3-dev libltdl-dev zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake zip unzip openjdk-17-jdk autoconf libtool pkg-config
          pip install --upgrade buildozer cython virtualenv

      - name: Initialize Buildozer
        run: buildozer init

      - name: Inject Configuration (Python Script)
        run: |
          cat <<EOF > fix_spec.py
          import os
          with open("buildozer.spec", "r") as f:
              content = f.read()
          
          replacements = {
              "title = My Application": "title = AI Vision Pro",
              "package.name = myapp": "package.name = aivisionpro",
              "package.domain = org.test": "package.domain = com.niujuzhang",
              "source.include_exts = py,png,jpg,kv,atlas": "source.include_exts = py,png,jpg,kv,atlas,ttf,json",
              "requirements = python3,kivy": "requirements = python3,kivy==2.3.0,kivymd==1.2.0,requests,urllib3,chardet,idna,pillow,openssl",
              "#android.permissions = INTERNET": "android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE",
              "#android.archs = arm64-v8a, armeabi-v7a": "android.archs = arm64-v8a, armeabi-v7a",
              "#android.api = 31": "android.api = 33",
              "#android.minapi = 21": "android.minapi = 24",
              "# android.accept_sdk_license = False": "android.accept_sdk_license = True",
              "# icon.filename = %(source.dir)s/data/icon.png": "icon.filename = %(source.dir)s/icon.png",
              "# presplash.filename = %(source.dir)s/data/presplash.png": "presplash.filename = %(source.dir)s/icon.png",
          }
          
          for old, new in replacements.items():
              if old in content:
                  content = content.replace(old, new)
          
          with open("buildozer.spec", "w") as f:
              f.write(content)
          print("âœ… Buildozer spec configured successfully!")
          EOF
          
          python3 fix_spec.py

      - name: Build APK (Run Buildozer)
        run: |
          yes | buildozer android debug

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-Vision-Pro-APK
          path: bin/*.apk
